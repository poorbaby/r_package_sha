---
title: "Intro to Sha Package for Sleep and Health Analysis"
author: "Yunrou Gong"
date: "`r Sys.Date()`"
output: rmarkdown::html_document

vignette: >
  %\VignetteIndexEntry{Sleep and Health Analysis with Sha}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
# Introduction
The *sha* package is used for analysing sleep duration and other atrributes related to health. The name **Sha**  is the abbreviation of Sleep Health Analysis. We may have curious about weather sleep duration will be influenced by the weight, tempreture, activities, day of the week, and heart rate. Intuitively, sleep time and the other attributes are not that correlated. But, we could use this package to conduct detail analysis to answer intereting questions, which may be counter intuitive. 

# Description of Original Dataset 
In order to show you how to use *sha* package to do intereting analysis on sleep and health data, I collected my own data via google sheet. I made it published so you can fetch this dataset via "googlesheets" package. 
```{r loaddata, echo=TRUE, message=FALSE}
library("googlesheets")
googlekey <- gs_url("https://docs.google.com/spreadsheets/d/1KdOw0FIxY2Kt8UgY16F3UMQSC7KJaBgtmewNZUGuLY8/edit#gid=0",lookup = FALSE,visibility = "public")
mydata <- gs_read(googlekey, skip = 3)
```
```{r data_view, echo=TRUE, results='asis'}
knitr::kable(head(mydata), format = "markdown", align = 'c')
```
```{r str_data, echo= FALSE, include= FALSE}
no_of_col <- dim(mydata)[2]
var_names <- colnames(mydata)
```

The collected  dataset contains `r no_of_col` variables related to one individual's sleep and health data and recoded each observation daily. 
The following is the variable explanation:

1. `r var_names[1]`: in format of month/date/year started from Sep.11 2017
2. `r var_names[2]`: the name of the day during a week (Mon,Tue,Wed,Thu,Fri,Sat,Sun)
3. `r var_names[3]`: body weight in kg
4. `r var_names[4]`: total sleep time per night measured in hour
5. `r var_names[5]`: daily condition of the weather (Sunny, Cloudy, Rainy, Snowy)
6. `r var_names[6]`: daily average tempreture in Celsius
7. `r var_names[7]`: ActivitybySteps: a measurement of activity in steps
8. `r var_names[8]`: heart rate in beats per minute (bpm)


# Data Cleaning
### Generate a New Variable from column "DayofWeek"
Intuitively, weekday should have similar pattern on sleep duration compared to that of weekend. So we could generate a new variable name as "DayType" to classify each day as weekday or weekend. The more convinient way is to use library **tidyverse** as showing below.

```{r dataclean01, echo=TRUE, message=FALSE}
library(tidyverse)
mydata <- mydata %>% 
  mutate(DayType = ifelse(DayofWeek %in% c("Sat", "Sun"), "Weekend", "Weekday")) %>% 
  select(-DayofWeek) 
```

```{r schema, echo=TRUE, results='asis'}
sch <- c("Date", "Weight(kg)", "SleepDuration(hr)", "Weatehr", "Tempreture(c)", "Activity(steps)", 
         "HeartRate(bpm)", "DayType")
knitr::kable(head(mydata, 10), col.names = sch, align = "c")

```

Now, the following analysis are based on this dataset which is named as mydata. 

# Explotory Data Analysis

## Basic Statistics and useful information
Here, we are going to use "tidyverse" library to manupilate the "mydata" dataset and get the useful information. 


```{r count, echo=TRUE }
n <- mydata %>%
  summarize(n = n())
```

The above code give us the number of observations of a dataset. There are `r n` observations in the *mydata* dataset
We can also  get the number of observations in specfic conditions. For example, we are going to check how many observations are there that Sleep duration are over 8 hours and the tempreture is over 20.

```{r count2, echo=TRUE }
count2 <- mydata %>% 
  filter(SleepDuration > 8 & Tempreture > 20) %>% 
  summarize(n = n())

```
So there are `r count2` days that sleep duration over 8 hours and the tempreture are above 20. 

We are going to find out the average sleep duration on weekday and on weekend and arrange them to see which group has longer sleep duration.
```{r sleep_by_day, echo=TRUE, results= 'asis'}
sleep_by_day <- mydata %>% 
  group_by(DayType) %>% 
  summarise(avg_sleep = mean (SleepDuration)) %>% 
  mutate(avg_sleep = round (avg_sleep, 2)) %>% 
  arrange(desc(avg_sleep))

knitr::kable(sleep_by_day, format = "markdown", align = 'l')
  
```

The results says that sleep duration are longer at weekend on average based on our existing data. 
Also, we can get the average sleep duration for different weather condition.

```{r avg_sleep2, echo=TRUE, results= 'asis'}
avg_sleep_weather <- mydata %>% 
  group_by(Weather) %>% 
  summarise(avg_sleep = mean(SleepDuration)) %>% 
  mutate(avg_sleep = round(avg_sleep, 2)) %>% 
  arrange(desc(avg_sleep))

knitr::kable(avg_sleep_weather, format = "markdown", align = 'l')

```

So from the above table, we will see that sleep duration of Sunny weather has the longest with `r avg_sleep_weather$avg_sleep[1]` hour on average , followed by Cloudy and Rainy weather condition, with `r avg_sleep_weather$avg_sleep[2]` hour,`r avg_sleep_weather$avg_sleep[3]`hour respectively. 


### Import the package *sha*

```{r sha, echo=TRUE, message=FALSE}
library(sha)
```

To make the catergorical variable to factor variable for following analysis. 
```{r as.factor, echo=TRUE}
mydata$DayType <- as.factor(mydata$DayType)
mydata$Weather <- as.factor(mydata$Weather)
```


## Scatter plot
You can use *plot_scatter* function to make scatter plot on two continues variable by group to check if they have linear relationship and how does the relationship accross differnty group type. 
The below graph shows us the relationship between seelp duration and weight. It seems that there is no significant linear relationship in both of the groups. However, we will also see that the data point of weekend has larger sleep time than weekday points. Thus, we can look at the distribution by plot a box plot. 
```{r scatterplot, echo= TRUE}
plot_scatter(mydata,"Weight","SleepDuration", "DayType")

```

Here is another example for looking at the relationship between activity steps and sleep duation.
You can use the *plot_scatter* function to make the plots on any two of the continues variable in the data set, and grouped by a categorical vatiable. 

```{r scatterplot2, echo=TRUE}
plot_scatter(mydata,"Activity","SleepDuration", "DayType")
```

From the above scatter plot, it seems that there is linear relationship between sleep duration and activity.


## Box plot 
Also, you can clss *plot_box* function to make the box plot according to the group variable. So, this will show you how disperse the data is distributed , how skew the distribution may be. Also, from the box plot below, we can also find out that the sleep duration are different between weekday and weekend. May be we could do a logsitic regression to further see how the DayType will affect the Sleep Duration. 

```{r boxplot, echo=TRUE}
plot_box(mydata, x = "DayType", y= "SleepDuration")
```


### Checking statistically significantly mean difference across the groups
Now let's check weather there is statistically significantly difference on average sleep duration between weekday and weekend.
We are using oneway-anova test so it is made strong assumption that the dependent variable observation is normal distributed and do not have outliers.

**H0: The mean of sleep duration between weekday and weekend are equal**

**H1: At least one is not equal to the others**
```{r anova_test, echo=TRUE}
summary(aov(SleepDuration ~ DayType, data = mydata ))

```
From the above testing results, the p-value for this test is far less than the 0.05 significant level. So we reject the null hypothesis and conclude that there is significant difference in the average sleep duration between weekday and weekend under 99.99% confidence. 

We again did the oneway-anova test on the sleep duration across different weather conditons:

**H0: The mean of sleep duration on different weather conditions are equal**

**H1: At least one is not equal to the others**

```{r anova_test2, echo=TRUE}
summary(aov(SleepDuration ~ Weather, data = mydata))
```
Since the p-value is larger than the 0.05 significant level, we fail to reject the null hypotheis that the mean of sleep duration on different weather conditions are equal. So there is no significant differences on average sleep duration accross different weather conditions under given data and evidence , with 95 % confidence. 

## Correlation Matrix

In the dataset, the weight , SleepDuration, Tempreture, Activity and Heart Rate are continues variables. So we can do a multiple correlation analysis on those continues variables to check the pair relationship. So we can use the function *paircorr* in "sha" package to calculate all the pair correlation among all the continues variable as *paircorr* will automatically detect the continues variables and give you the results. 

```{r paircorr1, echo=TRUE, results='asis'}
knitr::kable(paircorr(mydata), format = "markdown", align = "l", padding = 2 )
```



Additionaly, we can use **tidyverse** library to calculate the correlation between two continues variables by set more condtions. For example, we are interested in the correlation between the sleep duration and the tempreture separately for each day type only for Sunny weather condition, and return a sorted list of those correlation coeffients rounded to two digits. 
```{r corrleration2, echo=TRUE, results='asis'}
ans <- mydata %>% 
  filter(Weather == "Sunny") %>% 
  group_by(DayType) %>% 
  summarise(r = cor(SleepDuration, Tempreture)) %>% 
  mutate(r = round(r, 2)) %>% 
  arrange(desc(r))

knitr::kable(ans, format = "markdown", align = "l")  
```

So the results is quite interesting as there is positive correlation between sleep duration and tempreture on weekday and there is negative correlation between them on weekend under the weather is Sunny. 

# Modelling 
### Simple Linear Regression Model
According to the above correlation results, we could conduct a simple linear regression models to quantify the association between heart rate and tempreture. 

```{r slm1, echo=TRUE}
slm_model <- slm_s(mydata, x = "Tempreture", y="HeartRate")
slm_model
modelplot(mydata, x = "Tempreture", y="HeartRate")
```

The equation of the above linear model can be constructed from the output:

**Predicted Heart Rate  = ** `r round(coef(slm_model)[1], 4)` **+ (**`r round(coef(slm_model)[2],4)`**) * Tempreture**

The interpretation for the slope coefficient: With a unit celsius increase in tempreture,the heart rate, on average, decrease by approximately 0.5 bpm.

The interpretation for the intercept coefficient: When the tempreture is 0,the heart rate, on average, is 87 bpm. 

There is  an approximation of 8.817 the residuas tend to deviate around the regression line.

However, only approximately 7% of the variability in the heart rate variable is explained by the tempreture variable.

The intercept is extremely significant, while the slop p value is larger than 5% significant level, 
So the overall model is not significant.

We can further check the model assumption by Q-Q plot to see if the data are normal distributed.
```{r normalitycheck, echo=TRUE}
qqnorm(slm_model$residuals)
qqline(slm_model$residuals)
```

It seemes that the data are not follow normal distribution, which violte the the **Normality** assumption. 


### Multiple Linear Regression Model
Create a scatter matrix plot on all the continues variables. 
```{r scattermatrix, echo=TRUE}
par(ps = 12, cex = 1, cex.main = 1)
plot(mydata %>% select(SleepDuration, Weight, Tempreture, Activity, HeartRate), pch=16, col="blue", main="Matrix Scatterplot of SleepDuration, Weight, Tempreture, Activity and HeartRate")
```

From the above graph, the variables seems that corrlated to each other , so it may arise multicollinearity problem. 


Creating a multiple linear regression model included all variables except the date and weather, becasue the date is a distinct identifier, lika index; and Weather is kind of overlapping the information that provided by "Tempreture". 

```{r ml01, echo=TRUE}
ml.saturated = lm(SleepDuration ~ Weight + Tempreture + Activity + HeartRate +  DayType, 
                  data= mydata)
summary(ml.saturated)
```

The regression equation is :

**SleepDuration = 1.315 + 0.039*Weight + 0.043*Tempreture - 0.0003*Activity + 0.064*HeartRate - 1.478*Weekend**

Interpretion of the above equation under our problem context :

* When all attributes data are 0 and the day is weekend, the average expected duration of sleep is about 1.315 hour which does not make sense in context of our problem
* As the weight variable increases by one point, the sleep time increases on average by about 0.039 hour (approximately 140 second) WHILE HOLDING ALL OTHER VARIABLES CONSTANT
* As the tempreture increases by one point, the sleep time increases on average by about 0.043 hour (approximately 155 second) WHILE HOLDING ALL OTHER VARIABLES CONSTANT.
* As the activity increases by one step, the duration of sleep decreases on average by approximately 2 second, WHILE HOLDING ALL OTHER VARIABLES CONSTANT
* As the heart rate increase by 1 bmp, the duration of sleep increases on average by approximately 230 second, WHILE HOLDING ALL OTHER VARIABLES CONSTANT
* The average difference in sleep duration between weekend and weekday is approximately 89 minute, WHILE HOLDING ALL OTHER VARIABLES CONSTANT

Although only two of the attributes Activity and DayType are significant, the overall regression is significant as the p-value is far less than 0.05. 

The RSE is about 1.514, which is an estimate of the average deviation of the observations around the regression line.

More importanly, the adjusted R square is 0.335, meaning that approximately 33.5% of the variation in sleep duration is accounted for by the variables in our model, which indicates that the model is kind of poor in predicating the duration of sleep. Maybe, we should investigate the assumptions of the model. 

```{r assumption_check, echo= TRUE}
plot(ml.saturated)
```

According to the Q-Q plots, we will see that the data are not normal distributed which violated the Normality assumption for linear modelling. 


# Conclusion
Fitting linear models for predicting the duration of sleep seems do not have good performance based on the given data collected. And the data kind of not following normal distribution. But maybe because the size of the dataset is too small or we can use BoxCox to transform the data to see if the normality assumption is still violated.



```{r info, echo= T}
sessionInfo()
```


